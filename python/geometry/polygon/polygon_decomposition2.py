#!/usr/bin/python3
#\file    polygon_decomposition2.py
#\brief   Polygon decomposition algorithm using SplitPolygonAtReflexVertex and DivideConvexByArea.
#\author  Akihiko Yamaguchi, info@akihikoy.net
#\version 0.1
#\date    Aug.01, 2023

from polygon_divide_by_area import DivideConvexByArea
from polygon_split_at_reflex import SplitPolygonAtReflexVertex
from polygon_area import PolygonArea
from polygon_convex_ratio import ConvexRatio
import numpy as np
import time

#Polygon decomposition algorithm using SplitPolygonAtReflexVertex and DivideConvexByArea.
def DecomposePolygon(points, target_area, th_convex_ratio=0.8, scale_width=1.5, num_approx_refsplit=None):
  polygons= [points]
  decomposed= []
  while len(polygons)>0:
    polygon= polygons.pop(0)
    #t0= time.time()
    #print('# polygons={}, # decomposed={}, polygon size={}'.format(len(polygons),len(decomposed),len(polygon)))
    if PolygonArea(polygon)<2.0*target_area:
      decomposed.append(polygon)
      continue
    #print('  t1= {:6.2f}ms'.format((time.time()-t0)*1.e3)); t0=time.time()
    convex_ratio= ConvexRatio(polygon)
    #print('# polygons={}, # decomposed={}, polygon size={}, convex_ratio={}'.format(len(polygons),len(decomposed),len(polygon),convex_ratio))
    #print('  t2= {:6.2f}ms'.format((time.time()-t0)*1.e3)); t0=time.time()
    do_dcba= True
    if convex_ratio<th_convex_ratio:
      sub_polys= SplitPolygonAtReflexVertex(polygon, num_approx=num_approx_refsplit)
      #print('--SPARV # of sub_polys={}'.format(len(sub_polys)))
      if len(sub_polys)>1:
        polygons+= sub_polys
        do_dcba= False
    #print('  t3= {:6.2f}ms'.format((time.time()-t0)*1.e3)); t0=time.time()
    if do_dcba:
      sub_polys= DivideConvexByArea(polygon, target_area, scale_width=scale_width)
      #print('--DCBA # of sub_polys={}'.format(len(sub_polys)))
      decomposed+= sub_polys
    #print('  t4= {:6.2f}ms'.format((time.time()-t0)*1.e3)); t0=time.time()
  return decomposed



def Main():
  from polygon_shrink import ShrinkPolygon
  import time

  def write_polygon(fp,polygon):
    if len(polygon)>0:
      for pt in polygon+[polygon[0]]:
        fp.write('%s\n'%' '.join(map(str,pt)))
    fp.write('\n')

  polygons=[
    [[0.744, 0.54], [0.532, 1.124], [1.12, 0.996], [1.324, 1.432], [1.608, 1.12], [2.04, 0.632], [1.464, 0.696], [1.224, 0.328], [1.16, 0.7]],
    [[0.784, 0.58], [1.172, 1.096], [1.72, 0.524], [1.724, 1.496], [0.84, 1.516]],
    [[0.704, 0.748], [1.18, 0.42], [1.516, 0.704], [1.416, 0.936], [1.028, 1.052], [0.876, 1.384], [1.476, 1.28], [1.932, 1.012], [2.056, 1.436], [1.172, 1.752], [0.48, 1.62], [0.364, 1.064]],
    [[0.556, 0.764], [0.952, 0.316], [1.988, 0.368], [2.152, 0.668], [2.012, 0.928], [1.484, 0.872], [1.228, 0.936], [1.2, 1.156], [1.36, 1.312], [1.952, 1.328], [2.24, 1.432], [2.1, 1.648], [1.632, 1.844], [1.016, 1.812], [0.552, 1.492], [0.776, 1.324], [0.812, 1.068], [0.524, 0.952]],
    [[0.504, 0.724], [0.908, 0.296], [1.7, 0.304], [1.996, 0.668], [1.98, 0.872], [1.8, 0.996], [1.396, 0.984], [1.232, 1.296], [1.732, 1.484], [1.892, 1.792], [1.088, 1.756], [0.396, 1.5], [0.684, 1.26], [0.728, 0.98]],
    [[0.729,0.049],[0.723,0.082],[0.702,0.125],[0.682,0.124],[0.654,0.106],[0.656,0.101],[0.647,0.081],[0.652,0.078],[0.651,0.071],[0.655,0.071],[0.673,0.031]],
    [[0.722,0.219],[0.717,0.220],[0.712,0.229],[0.693,0.235],[0.681,0.227],[0.672,0.230],[0.649,0.211],[0.637,0.213],[0.629,0.208],[0.626,0.216],[0.620,0.202],[0.616,0.203],[0.617,0.207],[0.609,0.200],[0.603,0.201],[0.601,0.191],[0.587,0.181],[0.589,0.175],[0.580,0.166],[0.585,0.133],[0.593,0.121],[0.605,0.113],[0.626,0.113],[0.645,0.121],[0.644,0.127],[0.651,0.123],[0.661,0.135],[0.669,0.134],[0.675,0.140],[0.702,0.148],[0.715,0.159],[0.717,0.150],[0.720,0.149],[0.721,0.167],[0.727,0.167],[0.730,0.195],[0.724,0.204]],
    [[0.820,0.156],[0.793,0.154],[0.812,0.154],[0.812,0.150],[0.803,0.149],[0.806,0.134],[0.802,0.139],[0.796,0.133],[0.786,0.140],[0.779,0.139],[0.772,0.131],[0.774,0.126],[0.782,0.127],[0.779,0.134],[0.789,0.130],[0.788,0.115],[0.794,0.109],[0.773,0.111],[0.769,0.124],[0.755,0.143],[0.749,0.144],[0.753,0.150],[0.750,0.153],[0.737,0.147],[0.731,0.149],[0.738,0.141],[0.722,0.144],[0.722,0.124],[0.726,0.126],[0.729,0.123],[0.725,0.118],[0.733,0.107],[0.733,0.090],[0.738,0.086],[0.738,0.077],[0.740,0.082],[0.744,0.080],[0.749,0.041],[0.757,0.039],[0.758,0.032],[0.763,0.034],[0.762,0.040],[0.769,0.037],[0.769,0.008],[0.781,0.024],[0.778,0.034],[0.788,0.043],[0.828,0.144],[0.819,0.150]],
    [[-0.025303661779385922, 0.09245770317609564], [-0.0275987005764812, 0.06772534222075505], [0.00048378643370985963, 0.08467964618842833], [0.015245293591216985, 0.0437590556697558], [0.005123944099670236, 0.04168889111342888], [-0.011642189887424381, 0.03072040389189945], [-0.013851660834309276, 0.015085715499730645], [-0.03494577408566271, 0.02436160709635643], [-0.024857438439588958, 0.011325285863521162], [-0.02630701705128527, -0.0038395502507619916], [-0.04234313786125393, 0.0004431530855182886], [-0.04449361634377652, 0.02034244913479527], [-0.0586839138231392, 0.018392332332703987], [-0.057822607469446785, -0.00021708500205758208], [-0.07222304239452493, -0.005205874969570479], [-0.07149442200664391, -0.014430910383980533], [-0.05993369763435563, -0.02599620552138765], [-0.04737640555871353, -0.02343394596909132], [-0.017216923372809168, -0.03709647697356533], [-0.0030659091137402728, -0.03823786197232709], [-0.0008772623716073458, -0.027391059953021046], [0.019630459434188396, -0.041616861521988846], [0.045139200943733554, -0.03496631310084092], [0.04272115807161961, -0.0018659951257116725], [0.058501483743438276, 0.018452308562523945], [0.03843332933029989, 0.03444551431270082]],
    [[0.094594151382899, 0.03820798810291681], [0.09265367143181125, 0.015010346211912329], [0.0847604959142918, 0.009919783215238565], [0.08030132857078642, 0.021455867086076053], [0.06399085215624345, 0.019951398933859887], [0.0691365710888463, 0.04042682542090015], [0.03635270402696572, 0.03938127300507477], [0.034454397971981465, 0.033818085342381954], [0.021242141546509163, 0.033818085342381954], [0.019311099474613402, 0.04147237783672564], [0.016287545386957036, 0.03216590032275224], [0.003387534997107866, 0.03938127300507477], [0.013277085706065228, 0.027838902139496025], [0.009232689730932941, 0.01879579095433903], [0.0014237569083006552, 0.01894842016571563], [0.0017392765456150094, 0.027838902139496025], [-0.01474330796931389, 0.0344345426341125], [-0.022984600226778396, 0.029487812263150115], [-0.030521929206365317, 0.04199515404463827], [-0.02500075594264395, 0.01068749506756761], [-0.0361706678387215, -0.0018414800862779357], [-0.02792937558125702, -0.019979491446473152], [-0.03821301236811628, -0.020704020305394533], [-0.052896230913597325, -0.0041595086344800025], [-0.05561809180550595, 0.01827895519265088], [-0.0449851895010574, 0.04513181129211463], [-0.05686244337402352, 0.04565458750002738], [-0.05455922057270038, -0.0008322143233925328], [-0.0398645444213003, -0.022356205325024137], [-0.040460583940689854, -0.03423132468063084], [-0.04749680784993052, -0.034996789739245804], [-0.03421907939063523, -0.0383175342583823], [-0.030333070171642218, -0.029712398534292306], [0.03166292049547603, -0.028212758974732244], [0.0009504774523291237, -0.0259458378626668], [-0.0022013740387640812, -0.019779639040661823], [-0.006003906414632831, -0.02669492844140431], [-0.0216976918362759, -0.025660575364283345], [-0.02280228839543752, -0.018796046851160875], [-0.011446791066328121, -0.01338385095185668], [-0.021336341775285483, -0.0001925699626238453], [-0.002684474299809003, 0.00651251674996145], [0.0009504774523291237, -0.0027464747723674465], [0.02082778692097831, 0.017138693590746268], [0.052835288541894676, 0.0129987110266091], [0.05448354699338753, 0.021243261644879663], [0.07366246434113882, 0.016474750307371222], [0.07549038795976337, 0.000567719954818191], [0.08324116180371788, 0.010614838010380656], [0.08914966374731897, 0.00418112582064778], [0.05543156632849716, -0.037983159863655414], [0.07840068749711537, -0.015798847023140827], [0.09414291618968279, 0.011410888986343126]],
    #[[0.6,0.05],[0.65,0.05],[0.65,0.1],[0.6,0.1]],
    #[[0.6,0.15],[0.6,0.2],[0.65,0.15],[0.65,0.2]],
    #[[0.65,0.05],[0.7,0.05],[0.7,0.1]],
    #[[0.6,0.05],[0.6,0.1],[0.65,0.05],[0.65,0.1]],
    ]

  polygon= polygons[np.random.choice(list(range(len(polygons))))]
  bb_min,bb_max= np.min(polygon,axis=0),np.max(polygon,axis=0)
  ##TEST: Convert polygon to a 3d points:
  #polygon= [[x,y,np.max(bb_max-bb_min)*np.random.uniform(0.0,0.2)] for x,y in polygon]

  target_w= np.max(bb_max-bb_min)*np.random.uniform(0.0,0.5)
  #target_w= np.max(bb_max-bb_min)*0.2
  th_convex_ratio,scale_width,num_approx_refsplit= 0.8,1.5,None
  #target_w,th_convex_ratio,scale_width,num_approx_refsplit= 0.04,0.8,1.2,10
  t_start= time.time()
  sub_polys= DecomposePolygon(polygon, target_w**2, th_convex_ratio=th_convex_ratio, scale_width=scale_width, num_approx_refsplit=num_approx_refsplit)
  t_end= time.time()
  print('target_w={} (bb_max-bb_min={})'.format(target_w,np.max(bb_max-bb_min)))
  print('# of sub polygons:',len(sub_polys))
  print('compt. time={}s for # of vertex={}'.format(t_end-t_start,len(polygon)))

  with open('/tmp/polygons.dat','w') as fp:
    write_polygon(fp,polygon)
  with open('/tmp/sub_polys.dat','w') as fp:
    for sub_poly in sub_polys:
      write_polygon(fp,ShrinkPolygon(sub_poly,0.95))

def PlotGraphs():
  print('Plotting graphs..')
  import os
  commands=[
    '''qplot -x2 aaa
        -s 'set size ratio 1;'
        /tmp/polygons.dat u 1:2:'(column(-1)+1)' w lp lc var pt 4
        /tmp/sub_polys.dat u 1:2:'(column(-1)+1)' w lp lc var pt 4
        &''',
        #/tmp/polygons.dat u 1:2:-1 lc var w l
    '''''',
    '''''',
    ]
  for cmd in commands:
    if cmd!='':
      cmd= ' '.join(cmd.splitlines())
      print('###',cmd)
      os.system(cmd)

  print('##########################')
  print('###Press enter to close###')
  print('##########################')
  input()
  os.system('qplot -x2kill aaa')

if __name__=='__main__':
  import sys
  if len(sys.argv)>1 and sys.argv[1] in ('p','plot','Plot','PLOT'):
    PlotGraphs()
    sys.exit(0)
  Main()

  PlotGraphs()
  sys.exit(0)
